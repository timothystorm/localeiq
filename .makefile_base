# -----------------------------------------------------------------------------
# Base Make file for LocaleIQ modules.
#
# You can either include this base makefile in the module's makefile if you
# need to add custom commands, or use it directly as a symlink if you only
# need the standard commands.
#
# To include in a new module makefile, add (at the top of the module makefile):
# -include ../../.makefile_base
#
# To create a symlink in a new module directory, run:
# `ln -s ../../.makefile_base makefile`
#
# see: help target for enriching help output in child makefiles.
# ----------------------------------------------------------------------------
ROOT_DIR := $(shell pwd)
MODULE = $(notdir $(ROOT_DIR))

# ----------------------------------------------------------------------------
# Help
#
# Child makefiles should add `help-extra` target to add more help info.
# If you have no extra help to add, you can define an empty target.
#
# help-extra:
# ----------------------------------------------------------------------------
help:
	@echo "üöë \033[0;34m\033[0;34m[\033[0;33m$(MODULE)\033[0;34m] LocaleIQ makefile commands:\033[0m"
	@echo "  clean       Clean virtual environments and caches"
	@echo "  clean-cache Clean pycache and pytest caches"
	@echo "  clean-venv  Clean venv environments"
	@echo "  type-check  Run type checking"
	@echo "  lint-check  Run linting checks only"
	@echo "  lint-fix    Run linting and auto-fix issues"
	@echo "  format      Format code"
	@echo "  lint        Run all linting tasks (type-check, lint-fix, format)"
	@echo "  setup       Lock and install [$(MODULE)] dependencies"
	@echo "  test        Run tests synchronously"
	@echo "  help        Show this help message"
	@echo "  ------------------------------------------------------------"
	@$(MAKE) help-extra || true

# ----------------------------------------------------------------------------
# Testing
#
# Ensure pytest is installed in the module's poetry environment.
# ----------------------------------------------------------------------------
test:
	@echo "üß™ \033[0;34mtest \033[0;33m$(MODULE)...\033[0;34m\033[0m"
	@poetry run pytest --tb=short --no-header

# ----------------------------------------------------------------------------
# Linting & Formatting
#
# Ensure mypy and ruff are installed in the module's poetry environment.
# ----------------------------------------------------------------------------
type-check:
	@poetry run mypy --no-error-summary $(ROOT_DIR) || exit 1

lint-check:
	@poetry run ruff check --quiet $(ROOT_DIR) || exit 1

.PHONY: check
check:
	@echo "üîç \033[0;34mcheck \033[0;33m$(MODULE)...\033[0;34m\033[0m"
	@$(MAKE) type-check
	@$(MAKE) lint-check

lint-fix:
	@poetry run ruff check --fix --quiet $(ROOT_DIR) || exit 1

format:
	@poetry run ruff format --quiet $(ROOT_DIR) || exit 1

.PHONY: lint
lint:
	@echo "üö® \033[0;34mlint \033[0;33m$(MODULE)...\033[0;34m\033[0m"
	@$(MAKE) type-check
	@$(MAKE) lint-fix
	@$(MAKE) format

# ----------------------------------------------------------------------------
# Utility commands
#
# Ensure poetry is installed on the system and poetry env is set up for the
# module.
# ----------------------------------------------------------------------------
clean-cache:
	@find $(ROOT_DIR) -type d -name "__pycache__" -exec rm -rf {} +
	@find $(ROOT_DIR) -type d -name ".mypy_cache" -exec rm -rf {} +
	@find $(ROOT_DIR) -type d -name ".pytest_cache" -exec rm -rf {} +
	@find $(ROOT_DIR) -type d -name ".ruff_cache" -exec rm -rf {} +

clean-venv:
	@poetry env remove --all

PHONE: clean
clean:
	@echo "üßπ \033[0;34mclean \033[0;33m$(MODULE)...\033[0;34m\033[0m"
	@$(MAKE) clean-cache
	@$(MAKE) clean-venv

setup:
	@echo "üî® \033[0;34msetup \033[0;33m$(MODULE)...\033[0;34m\033[0m"
	@poetry lock || exit 1 && poetry install || exit 1
