# -----------------------------------------------------------------------------
# Base Make file for LocaleIQ modules.
#
# You can either include this base makefile in the module's makefile if you
# need to add custom commands, or use it directly as a symlink if you only
# need the standard commands.
#
# To include in a new module makefile, add (at the top of the module makefile):
# -include ../../.makefile_base
#
# To create a symlink in a new module directory, run:
# `ln -s ../../.makefile_base makefile`
# ----------------------------------------------------------------------------
ROOT_DIR := $(shell pwd)
MODULE = $(notdir $(ROOT_DIR))

# Color codes
BLUE=\033[0;34m
CYAN=\033[0;36m
GREEN=\033[0;32m
NC=\033[0m # No Color
RED=\033[0;31m
YELLOW=\033[1;33m

# -------------------------------------------------------------
# Child makefiles should add `help-extra` target to add more help info.
# If you have no extra help to add, you can define an empty `help-extra:` target.
# -------------------------------------------------------------
help:
	@echo "âœ¨ ${CYAN}COMMANDS:${NC}"
	@echo "  lint        Run all linting tasks (type-check, lint-fix, format)"
	@echo "  test        Run tests synchronously"
	@echo "  help        Show this help message"
	@echo "  ------------------------------------------------------------"
	@$(MAKE) help-extra || true

clean:
	@echo "ðŸ§¼  ${YELLOW}CLEAN $(MODULE)...${NC}"
	@find $(ROOT_DIR) -type d -name "__pycache__" -exec rm -rf {} +
	@find $(ROOT_DIR) -type d -name ".mypy_cache" -exec rm -rf {} +
	@find $(ROOT_DIR) -type d -name ".pytest_cache" -exec rm -rf {} +
	@find $(ROOT_DIR) -type d -name ".ruff_cache" -exec rm -rf {} +
    # sugmodules should NOT have their own lock file - only the root poetry.lock should be used
	@find $(ROOT_DIR) -type d -name "poetry.lock" -exec rm -rf {} +

lint:
	@echo "ðŸŽ¨  ${YELLOW}LINT $(MODULE)...${NC}"
	@poetry run ruff format --quiet .
	@poetry run ruff check --fix --quiet .
	@poetry run mypy --no-error-summary .

test:
	@echo "ðŸ§ª  ${YELLOW}TEST $(MODULE)...${NC}"
	@poetry run pytest